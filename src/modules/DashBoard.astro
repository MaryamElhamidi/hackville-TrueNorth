---
import { getCompanyDashboardData } from '../lib/dashboard/index.js';
import { transformMunicipalityToHeatmapData } from '../lib/dashboard/heatmap.js';

const companyIdFromCookie = Astro.cookies.get('activeCompanyId')?.value;
const dashboardData = await getCompanyDashboardData(companyIdFromCookie);
const { company, summary, municipalities, insights, topServices } = dashboardData;

// Transform data for heatmap
const heatmapData = transformMunicipalityToHeatmapData(municipalities, company ?? undefined);

// Make heatmap data available to client-side scripts
console.log('Server-side: heatmapData length:', heatmapData.length);
console.log('Server-side: municipalities length:', municipalities.length);
console.log('Server-side: company:', company?.companyName);


---

<div class="grid grid-cols-1 2xl:grid-cols-2 gap-4 pt-8 px-4 pb-4">
		<!-- Company Overview Widget -->
		<div
			class="p-4 bg-white border border-gray-200 rounded-lg shadow-sm 2xl:col-span-2 sm:p-6 dark:border-gray-700 sm:p-6 dark:bg-gray-800"
		>
			<div class="flex items-center justify-between mb-4">
				<div class="flex-shrink-0">
					<div class="flex items-center gap-3">
						<div>
							<span
								class="text-xl font-bold leading-none text-gray-900 sm:text-2xl dark:text-white"
								>{company?.companyName || 'No Company Selected'}</span
							>
							<h3 class="text-base font-light text-gray-500 dark:text-gray-400">
								Accessibility Dashboard
							</h3>
						</div>
					</div>
				</div>
				<div
					class="flex items-center justify-end flex-1 text-base font-medium text-blue-500 dark:text-blue-400"
				>
					{summary.totalMunicipalities} Municipalities
					<svg
						class="w-5 h-5 ml-1"
						fill="currentColor"
						viewBox="0 0 20 20"
						xmlns="http://www.w3.org/2000/svg"
						>
						<path
							fill-rule="evenodd"
							d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-8.293l-3-3a1 1 0 00-1.414 0l-3 3a1 1 0 011.414 1.414L9 9.414V13a1 1 0 102 0V9.414l1.293 1.293a1 1 0 001.414-1.414z"
							clip-rule="evenodd"></path>
					</svg>
				</div>
			</div>

			<!-- Company Insights -->
			<div class="mb-4">
				<h4 class="text-lg font-semibold text-gray-900 dark:text-white mb-2">AI Insights</h4>
				<p class="text-sm text-gray-600 dark:text-gray-400 leading-relaxed">
					{insights}
				</p>
			</div>

			<!-- Statistics Cards -->
			<div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-4">
				<div class="text-center">
					<div class="text-2xl font-bold text-red-600">{summary.severityBreakdown.critical}</div>
					<div class="text-sm text-gray-500 dark:text-gray-400">Critical Needs</div>
				</div>
				<div class="text-center">
					<div class="text-2xl font-bold text-orange-600">{summary.severityBreakdown.moderate}</div>
					<div class="text-sm text-gray-500 dark:text-gray-400">Moderate Needs</div>
				</div>
				<div class="text-center">
					<div class="text-2xl font-bold text-green-600">{summary.severityBreakdown.low}</div>
					<div class="text-sm text-gray-500 dark:text-gray-400">Low Needs</div>
				</div>
				<div class="text-center">
					<div class="text-2xl font-bold text-blue-600">{summary.averageIssues}</div>
					<div class="text-sm text-gray-500 dark:text-gray-400">Avg Issues</div>
				</div>
			</div>
		</div>

		<!-- Municipalities Overview -->
		<div
			class="p-4 bg-white border border-gray-200 rounded-lg shadow-sm 2xl:col-span-2 sm:p-6 dark:border-gray-700 dark:bg-gray-800"
		>
			<div class="flex items-center justify-between mb-4">
				<div class="flex-shrink-0">
					<button
						id="municipalities-dropdown-toggle"
						class="flex items-center text-lg font-bold leading-none text-gray-900 sm:text-xl dark:text-white hover:text-blue-600 dark:hover:text-blue-400 transition-colors"
					>
						Municipality Accessibility Overview
						<svg
							class="w-5 h-5 ml-2 transition-transform"
							id="municipalities-dropdown-arrow"
							fill="none"
							stroke="currentColor"
							viewBox="0 0 24 24"
							xmlns="http://www.w3.org/2000/svg"
						>
							<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
						</svg>
					</button>
					<p class="text-sm font-light text-gray-500 dark:text-gray-400 mt-1">
						Filtered by {company?.companyName || 'Selected Company'}'s geographic focus and industry
					</p>
				</div>
			</div>

			<!-- Collapsible Municipalities Cards -->
			<div id="municipalities-content" class="hidden space-y-4">
				<!-- Critical Needs Card -->
				<div class="border border-red-200 rounded-lg dark:border-red-700">
					<button
						class="w-full p-4 text-left bg-red-50 dark:bg-red-900/20 hover:bg-red-100 dark:hover:bg-red-900/30 transition-colors flex items-center justify-between"
						onclick="toggleCard('critical-card')"
					>
						<span class="text-lg font-semibold text-red-800 dark:text-red-200">Critical Needs</span>
						<svg
							class="w-5 h-5 text-red-600 dark:text-red-400 transition-transform"
							id="critical-card-arrow"
							fill="none"
							stroke="currentColor"
							viewBox="0 0 24 24"
							xmlns="http://www.w3.org/2000/svg"
						>
							<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
						</svg>
					</button>
					<div id="critical-card-content" class="hidden px-4 pb-4 space-y-2">
						{municipalities.filter(m => m.severity === 'critical').map((municipality) => (
							<div class={`p-3 rounded-lg border-2 ${municipality.colorClass} bg-opacity-10`}>
								<div class="flex items-center justify-between mb-1">
									<h4 class="text-base font-semibold text-gray-900 dark:text-white">
										{municipality.municipality}
									</h4>
									<span class="px-2 py-1 text-xs font-medium rounded-full bg-red-100 text-red-800">
										{municipality.issues_count} issues
									</span>
								</div>
								<p class="text-sm text-gray-600 dark:text-gray-400 mb-1">
									{municipality.summary}
								</p>
								<div class="text-xs text-gray-500 dark:text-gray-400">
									Services affected: {municipality.top_services_affected.join(', ')}
								</div>
							</div>
						))}
						{municipalities.filter(m => m.severity === 'critical').length === 0 && (
							<p class="text-sm text-gray-500 dark:text-gray-400 text-center py-2">No critical needs found.</p>
						)}
					</div>
				</div>

				<!-- Moderate Needs Card -->
				<div class="border border-orange-200 rounded-lg dark:border-orange-700">
					<button
						class="w-full p-4 text-left bg-orange-50 dark:bg-orange-900/20 hover:bg-orange-100 dark:hover:bg-orange-900/30 transition-colors flex items-center justify-between"
						onclick="toggleCard('moderate-card')"
					>
						<span class="text-lg font-semibold text-orange-800 dark:text-orange-200">Moderate Needs</span>
						<svg
							class="w-5 h-5 text-orange-600 dark:text-orange-400 transition-transform"
							id="moderate-card-arrow"
							fill="none"
							stroke="currentColor"
							viewBox="0 0 24 24"
							xmlns="http://www.w3.org/2000/svg"
						>
							<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
						</svg>
					</button>
					<div id="moderate-card-content" class="hidden px-4 pb-4 space-y-2">
						{municipalities.filter(m => m.severity === 'moderate').map((municipality) => (
							<div class={`p-3 rounded-lg border-2 ${municipality.colorClass} bg-opacity-10`}>
								<div class="flex items-center justify-between mb-1">
									<h4 class="text-base font-semibold text-gray-900 dark:text-white">
										{municipality.municipality}
									</h4>
									<span class="px-2 py-1 text-xs font-medium rounded-full bg-orange-100 text-orange-800">
										{municipality.issues_count} issues
									</span>
								</div>
								<p class="text-sm text-gray-600 dark:text-gray-400 mb-1">
									{municipality.summary}
								</p>
								<div class="text-xs text-gray-500 dark:text-gray-400">
									Services affected: {municipality.top_services_affected.join(', ')}
								</div>
							</div>
						))}
						{municipalities.filter(m => m.severity === 'moderate').length === 0 && (
							<p class="text-sm text-gray-500 dark:text-gray-400 text-center py-2">No moderate needs found.</p>
						)}
					</div>
				</div>

				<!-- Low Needs Card -->
				<div class="border border-green-200 rounded-lg dark:border-green-700">
					<button
						class="w-full p-4 text-left bg-green-50 dark:bg-green-900/20 hover:bg-green-100 dark:hover:bg-green-900/30 transition-colors flex items-center justify-between"
						onclick="toggleCard('low-card')"
					>
						<span class="text-lg font-semibold text-green-800 dark:text-green-200">Low Needs</span>
						<svg
							class="w-5 h-5 text-green-600 dark:text-green-400 transition-transform"
							id="low-card-arrow"
							fill="none"
							stroke="currentColor"
							viewBox="0 0 24 24"
							xmlns="http://www.w3.org/2000/svg"
						>
							<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
						</svg>
					</button>
					<div id="low-card-content" class="hidden px-4 pb-4 space-y-2">
						{municipalities.filter(m => m.severity === 'low').map((municipality) => (
							<div class={`p-3 rounded-lg border-2 ${municipality.colorClass} bg-opacity-10`}>
								<div class="flex items-center justify-between mb-1">
									<h4 class="text-base font-semibold text-gray-900 dark:text-white">
										{municipality.municipality}
									</h4>
									<span class="px-2 py-1 text-xs font-medium rounded-full bg-green-100 text-green-800">
										{municipality.issues_count} issues
									</span>
								</div>
								<p class="text-sm text-gray-600 dark:text-gray-400 mb-1">
									{municipality.summary}
								</p>
								<div class="text-xs text-gray-500 dark:text-gray-400">
									Services affected: {municipality.top_services_affected.join(', ')}
								</div>
							</div>
						))}
						{municipalities.filter(m => m.severity === 'low').length === 0 && (
							<p class="text-sm text-gray-500 dark:text-gray-400 text-center py-2">No low needs found.</p>
						)}
					</div>
				</div>

				<!-- Avg Issues Card -->
				<div class="border border-blue-200 rounded-lg dark:border-blue-700">
					<button
						class="w-full p-4 text-left bg-blue-50 dark:bg-blue-900/20 hover:bg-blue-100 dark:hover:bg-blue-900/30 transition-colors flex items-center justify-between"
						onclick="toggleCard('avg-card')"
					>
						<span class="text-lg font-semibold text-blue-800 dark:text-blue-200">Avg Issues</span>
						<svg
							class="w-5 h-5 text-blue-600 dark:text-blue-400 transition-transform"
							id="avg-card-arrow"
							fill="none"
							stroke="currentColor"
							viewBox="0 0 24 24"
							xmlns="http://www.w3.org/2000/svg"
						>
							<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
						</svg>
					</button>
					<div id="avg-card-content" class="hidden px-4 pb-4 space-y-2">
						{municipalities.filter(m => Number(m.issues_count) === Number(summary.averageIssues)).map((municipality) => (
							<div class={`p-3 rounded-lg border-2 ${municipality.colorClass} bg-opacity-10`}>
								<div class="flex items-center justify-between mb-1">
									<h4 class="text-base font-semibold text-gray-900 dark:text-white">
										{municipality.municipality}
									</h4>
									<span class="px-2 py-1 text-xs font-medium rounded-full bg-blue-100 text-blue-800">
										{municipality.issues_count} issues
									</span>
								</div>
								<p class="text-sm text-gray-600 dark:text-gray-400 mb-1">
									{municipality.summary}
								</p>
								<div class="text-xs text-gray-500 dark:text-gray-400">
									Services affected: {municipality.top_services_affected.join(', ')}
								</div>
							</div>
						))}
						{municipalities.filter(m => Number(m.issues_count) === Number(summary.averageIssues)).length === 0 && (
							<p class="text-sm text-gray-500 dark:text-gray-400 text-center py-2">No municipalities with average issues found.</p>
						)}
					</div>
				</div>
			</div>

			{municipalities.length === 0 && (
				<div class="text-center py-8">
					<p class="text-gray-500 dark:text-gray-400">
						No municipalities found matching {company?.companyName || 'Selected Company'}'s criteria.
					</p>
				</div>
			)}
		</div>

		<!-- Service Gap Heatmap -->
		<div
			class="p-4 bg-white border border-gray-200 rounded-lg shadow-sm dark:border-gray-700 dark:bg-gray-800"
		>
			<div class="flex items-center justify-between mb-4">
				<div class="flex-shrink-0">
					<span
						class="text-lg font-bold leading-none text-gray-900 sm:text-xl dark:text-white"
						>Service Gap Heatmap</span
					>
					<p class="text-sm font-light text-gray-500 dark:text-gray-400 mt-1">
						Interactive map showing accessibility service gaps across Canada
					</p>
				</div>
			</div>

			<!-- Heatmap Container -->
			<div id="service-gap-heatmap-container" class="w-full h-96 bg-gray-100 dark:bg-gray-700 rounded-lg">
				<!-- Heatmap will be initialized here -->
			</div>
		</div>

		<!-- Top Services Affected -->
		<div
			class="p-4 bg-white border border-gray-200 rounded-lg shadow-sm dark:border-gray-700 sm:p-6 dark:bg-gray-800"
		>
			<h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">
				Top Services Affected
			</h3>
			<div class="space-y-3">
				{topServices.map((service, index) => (
					<div class="flex items-center justify-between">
						<div class="flex items-center">
							<span class="flex-shrink-0 w-6 h-6 bg-blue-100 text-blue-800 rounded-full flex items-center justify-center text-xs font-medium mr-3">
								{index + 1}
							</span>
							<span class="text-sm text-gray-900 dark:text-white">{service.service}</span>
						</div>
						<span class="text-sm font-medium text-gray-500 dark:text-gray-400">
							{service.count} municipalities
						</span>
					</div>
				))}
			</div>
		</div>
</div>

<script define:vars={{ heatmapData, municipalities }}>
	// Set heatmap data on window for client-side scripts
	window.heatmapData = heatmapData;
	window.originalMunicipalities = municipalities;
	window.allCompanies = [{ companyId: 'default', companyName: 'Demo Company', geographicFocus: ['Nationwide'], industry: 'Other' }];
</script>

<script>
	import './DashBoard.client.ts';
	import './DashBoard-heatmap.client.ts';

	// Update company name from user data on client side
	import { getCurrentUser } from '../services/auth.js';
	import { getCompanyById } from '../lib/company/index.js';

	// Toggle functions for municipalities dropdown
	(window as any).toggleMunicipalitiesDropdown = function() {
		const content = document.getElementById('municipalities-content');
		const arrow = document.getElementById('municipalities-dropdown-arrow');
		if (content && arrow) {
			const isHidden = content.classList.contains('hidden');
			if (isHidden) {
				content.classList.remove('hidden');
				arrow.classList.add('rotate-180');
			} else {
				content.classList.add('hidden');
				arrow.classList.remove('rotate-180');
			}
		}
	};

	(window as any).toggleCard = function(cardId) {
		const content = document.getElementById(cardId + '-content');
		const arrow = document.getElementById(cardId + '-arrow');
		if (content && arrow) {
			const isHidden = content.classList.contains('hidden');
			if (isHidden) {
				content.classList.remove('hidden');
				arrow.classList.add('rotate-180');
			} else {
				content.classList.add('hidden');
				arrow.classList.remove('rotate-180');
			}
		}
	};

	document.addEventListener('DOMContentLoaded', () => {
		const companySelector = document.getElementById('company-selector');
		if (companySelector) {
			companySelector.addEventListener('change', () => {
				// For demo purposes, we'll reload the page. In a real app,
				// this would update the active company in the session/user context
				window.location.reload();
			});
		}

		// Add event listener for municipalities dropdown
		const dropdownToggle = document.getElementById('municipalities-dropdown-toggle');
		if (dropdownToggle) {
			dropdownToggle.addEventListener('click', window.toggleMunicipalitiesDropdown);
		}
	});
</script>

<style is:global>
	/* chart styles */
	.apexcharts-tooltip {
		@apply bg-white dark:bg-gray-700 text-gray-500 dark:text-gray-400 border-0 rounded-lg shadow-lg !important;
	}

	.apexcharts-tooltip .apexcharts-tooltip-title {
		@apply py-2 px-4 bg-gray-100 dark:bg-gray-600 border-b border-gray-200 dark:border-gray-500 !important;
	}

	.apexcharts-xaxistooltip {
		@apply text-gray-500 border-0 bg-white dark:bg-gray-700 dark:text-gray-300 rounded-lg shadow-lg !important;
	}

	.apexcharts-tooltip .apexcharts-tooltip-text-y-value {
		@apply dark:text-white;
	}

	.apexcharts-xaxistooltip-text {
		@apply font-medium text-sm !important;
	}

	.apexcharts-xaxistooltip:before,
	.apexcharts-xaxistooltip:after {
		@apply border-0 !important;
	}
</style>
