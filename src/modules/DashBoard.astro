---
import { getCompanyDashboardData } from '../lib/dashboard/index.js';
import { loadCompanies } from '../lib/company/index.js';
import { transformMunicipalityToHeatmapData } from '../lib/dashboard/heatmap.js';

const companyIdFromCookie = Astro.cookies.get('activeCompanyId')?.value;
const dashboardData = await getCompanyDashboardData(companyIdFromCookie);
const { company, summary, municipalities, insights, topServices } = dashboardData;
const allCompanies = loadCompanies();

// Transform data for heatmap
const heatmapData = transformMunicipalityToHeatmapData(municipalities, company ?? undefined);

// Make heatmap data available to client-side scripts
if (typeof window !== 'undefined') {
	(window as any).heatmapData = heatmapData;
}
---

<div class="grid grid-cols-1 2xl:grid-cols-2 gap-4 p-4">
		<!-- Company Overview Widget -->
		<div
			class="p-4 bg-white border border-gray-200 rounded-lg shadow-sm 2xl:col-span-2 sm:p-6 dark:border-gray-700 sm:p-6 dark:bg-gray-800"
		>
			<div class="flex items-center justify-between mb-4">
				<div class="flex-shrink-0">
					<div class="flex items-center gap-3">
						<div>
							<span
								class="text-xl font-bold leading-none text-gray-900 sm:text-2xl dark:text-white"
								>{company?.companyName || 'Selected Company'}</span
							>
							<h3 class="text-base font-light text-gray-500 dark:text-gray-400">
								Accessibility Dashboard
							</h3>
						</div>
						<!-- Company Selector -->
						{allCompanies.length > 1 && (
							<div class="relative">
								<select
									id="company-selector"
									class="block w-full pl-3 pr-10 py-2 text-sm border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white"
									value={company?.companyId || ''}
								>
									{allCompanies.map((comp) => (
										<option value={comp.companyId}>{comp.companyName}</option>
									))}
								</select>
							</div>
						)}
					</div>
				</div>
				<div
					class="flex items-center justify-end flex-1 text-base font-medium text-blue-500 dark:text-blue-400"
				>
					{summary.totalMunicipalities} Municipalities
					<svg
						class="w-5 h-5 ml-1"
						fill="currentColor"
						viewBox="0 0 20 20"
						xmlns="http://www.w3.org/2000/svg"
						>
						<path
							fill-rule="evenodd"
							d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-8.293l-3-3a1 1 0 00-1.414 0l-3 3a1 1 0 011.414 1.414L9 9.414V13a1 1 0 102 0V9.414l1.293 1.293a1 1 0 001.414-1.414z"
							clip-rule="evenodd"></path>
					</svg>
				</div>
			</div>

			<!-- Company Insights -->
			<div class="mb-4">
				<h4 class="text-lg font-semibold text-gray-900 dark:text-white mb-2">AI Insights</h4>
				<p class="text-sm text-gray-600 dark:text-gray-400 leading-relaxed">
					{insights}
				</p>
			</div>

			<!-- Statistics Cards -->
			<div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-4">
				<div class="text-center">
					<div class="text-2xl font-bold text-red-600">{summary.severityBreakdown.critical}</div>
					<div class="text-sm text-gray-500 dark:text-gray-400">Critical Needs</div>
				</div>
				<div class="text-center">
					<div class="text-2xl font-bold text-orange-600">{summary.severityBreakdown.moderate}</div>
					<div class="text-sm text-gray-500 dark:text-gray-400">Moderate Needs</div>
				</div>
				<div class="text-center">
					<div class="text-2xl font-bold text-green-600">{summary.severityBreakdown.low}</div>
					<div class="text-sm text-gray-500 dark:text-gray-400">Low Needs</div>
				</div>
				<div class="text-center">
					<div class="text-2xl font-bold text-blue-600">{summary.averageIssues}</div>
					<div class="text-sm text-gray-500 dark:text-gray-400">Avg Issues</div>
				</div>
			</div>
		</div>

		<!-- Municipalities Overview -->
		<div
			class="p-4 bg-white border border-gray-200 rounded-lg shadow-sm 2xl:col-span-2 sm:p-6 dark:border-gray-700 dark:bg-gray-800"
		>
			<div class="flex items-center justify-between mb-4">
				<div class="flex-shrink-0">
					<span
						class="text-lg font-bold leading-none text-gray-900 sm:text-xl dark:text-white"
						>Municipality Accessibility Overview</span
					>
					<p class="text-sm font-light text-gray-500 dark:text-gray-400 mt-1">
						Filtered by {company?.companyName || 'Selected Company'}'s geographic focus and industry
					</p>
				</div>
			</div>

			<!-- Municipalities List -->
			<div class="space-y-4">
				{municipalities.map((municipality) => {
					let severityClass = 'bg-green-100 text-green-800';
					if (municipality.severity === 'critical') {
						severityClass = 'bg-red-100 text-red-800';
					} else if (municipality.severity === 'moderate') {
						severityClass = 'bg-orange-100 text-orange-800';
					}
					return (
						<div class={`p-4 rounded-lg border-2 ${municipality.colorClass} bg-opacity-10`}>
							<div class="flex items-center justify-between mb-2">
								<h4 class="text-lg font-semibold text-gray-900 dark:text-white">
									{municipality.municipality}
								</h4>
								<span class={`px-2 py-1 text-xs font-medium rounded-full ${severityClass}`}>
									{municipality.issues_count} issues
								</span>
							</div>
							<p class="text-sm text-gray-600 dark:text-gray-400 mb-2">
								{municipality.summary}
							</p>
							<div class="flex items-center justify-between text-xs text-gray-500 dark:text-gray-400">
								<span>Services affected: {municipality.top_services_affected.join(', ')}</span>
								<span>Severity: {municipality.severity}</span>
							</div>
						</div>
					);
				})}
			</div>

			{municipalities.length === 0 && (
				<div class="text-center py-8">
					<p class="text-gray-500 dark:text-gray-400">
						No municipalities found matching {company?.companyName || 'Selected Company'}'s criteria.
					</p>
				</div>
			)}
		</div>

		<!-- Service Gap Heatmap -->
		<div
			class="p-4 bg-white border border-gray-200 rounded-lg shadow-sm 2xl:col-span-2 dark:border-gray-700 dark:bg-gray-800"
		>
			<div class="flex items-center justify-between mb-4">
				<div class="flex-shrink-0">
					<span
						class="text-lg font-bold leading-none text-gray-900 sm:text-xl dark:text-white"
						>Service Gap Heatmap</span
					>
					<p class="text-sm font-light text-gray-500 dark:text-gray-400 mt-1">
						Interactive map showing accessibility service gaps across Canada
					</p>
				</div>
			</div>

			<!-- Heatmap Container -->
			<div id="service-gap-heatmap-container" class="w-full h-96 bg-gray-100 dark:bg-gray-700 rounded-lg">
				<!-- Heatmap will be initialized here -->
			</div>
		</div>

		<!-- Top Services Affected -->
		<div
			class="p-4 bg-white border border-gray-200 rounded-lg shadow-sm dark:border-gray-700 sm:p-6 dark:bg-gray-800"
		>
			<h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">
				Top Services Affected
			</h3>
			<div class="space-y-3">
				{topServices.map((service, index) => (
					<div class="flex items-center justify-between">
						<div class="flex items-center">
							<span class="flex-shrink-0 w-6 h-6 bg-blue-100 text-blue-800 rounded-full flex items-center justify-center text-xs font-medium mr-3">
								{index + 1}
							</span>
							<span class="text-sm text-gray-900 dark:text-white">{service.service}</span>
						</div>
						<span class="text-sm font-medium text-gray-500 dark:text-gray-400">
							{service.count} municipalities
						</span>
					</div>
				))}
			</div>
		</div>
</div>

<script>
	import './DashBoard.client.ts';
	import './DashBoard-heatmap.client.ts';

	// Handle company selector change
	document.addEventListener('DOMContentLoaded', () => {
		const companySelector = document.getElementById('company-selector');
		if (companySelector) {
			companySelector.addEventListener('change', () => {
				// @ts-ignore
				const selectedCompanyId = companySelector.value;
				// Store the selected company ID in a cookie
				document.cookie = `activeCompanyId=${selectedCompanyId}; path=/; max-age=31536000`; // 1 year expiry
				// Reload the page to reflect the change
				window.location.reload();
			});
		}
	});
</script>

<style is:global>
	/* chart styles */
	.apexcharts-tooltip {
		@apply bg-white dark:bg-gray-700 text-gray-500 dark:text-gray-400 border-0 rounded-lg shadow-lg !important;
	}

	.apexcharts-tooltip .apexcharts-tooltip-title {
		@apply py-2 px-4 bg-gray-100 dark:bg-gray-600 border-b border-gray-200 dark:border-gray-500 !important;
	}

	.apexcharts-xaxistooltip {
		@apply text-gray-500 border-0 bg-white dark:bg-gray-700 dark:text-gray-300 rounded-lg shadow-lg !important;
	}

	.apexcharts-tooltip .apexcharts-tooltip-text-y-value {
		@apply dark:text-white;
	}

	.apexcharts-xaxistooltip-text {
		@apply font-medium text-sm !important;
	}

	.apexcharts-xaxistooltip:before,
	.apexcharts-xaxistooltip:after {
		@apply border-0 !important;
	}
</style>
