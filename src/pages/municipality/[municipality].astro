---
import LayoutSidebar from '../../app/LayoutSidebar.astro';
import { getCompanySpecificMunicipalitySummary } from '../../lib/dashboard/index.js';
import { getActiveCompany } from '../../lib/company/index.js';
import { loadMunicipalitySummaries } from '../../lib/dashboard/filtering.js';

export async function getStaticPaths() {
  // Generate paths for all municipalities
  const municipalities = loadMunicipalitySummaries();

  return municipalities.map((municipality) => ({
    params: {
      municipality: municipality.municipality
    }
  }));
}

const { municipality } = Astro.params;
const company = getActiveCompany();

// Parse URL parameters for issue-specific data
const url = new URL(Astro.request.url);
const issueData = {
  severity: url.searchParams.get('severity') || 'minor',
  issues_count: parseInt(url.searchParams.get('issues_count') || '0'),
  affected_populations: parseInt(url.searchParams.get('affected_populations') || '0'),
  service_gap_types: url.searchParams.get('service_gap_types')?.split(',') || [],
  accessibility_barriers: url.searchParams.get('accessibility_barriers')?.split(',') || [],
  top_services_affected: url.searchParams.get('top_services_affected')?.split(',') || [],
  summary: url.searchParams.get('summary') || ''
};

let summary = '';
let error = '';

if (company && municipality) {
  try {
    summary = await getCompanySpecificMunicipalitySummary(municipality);
  } catch (err) {
    error = 'Unable to generate municipality analysis. Please try again.';
    console.error('Error generating municipality summary:', err);
  }
} else {
  error = 'No active company or municipality specified.';
}
---

<LayoutSidebar title={`${municipality || 'Unknown Municipality'} - Service Gap Analysis`}>
  <div class="px-4 pt-6 bg-gray-50 dark:bg-gray-900 min-h-screen">
    <div class="max-w-4xl mx-auto">
      <!-- Header -->
      <div class="mb-6">
        <div class="flex items-center justify-between">
          <div>
            <h1 class="text-3xl font-bold text-gray-900 dark:text-white">
              {municipality} Service Gap Analysis
            </h1>
            <p class="text-lg text-gray-600 dark:text-gray-400 mt-2">
              Personalized insights for {company?.companyName || 'your company'}
            </p>
          </div>
          <a
            href="/dashboard"
            class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500"
          >
            ‚Üê Back to Dashboard
          </a>
        </div>
      </div>

      {error ? (
        <!-- Error State -->
        <div class="bg-red-50 border border-red-200 rounded-md p-4">
          <div class="flex">
            <div class="flex-shrink-0">
              <svg class="h-5 w-5 text-red-400" viewBox="0 0 20 20" fill="currentColor">
                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" />
              </svg>
            </div>
            <div class="ml-3">
              <h3 class="text-sm font-medium text-red-800">
                Analysis Unavailable
              </h3>
              <div class="mt-2 text-sm text-red-700">
                <p>{error}</p>
              </div>
            </div>
          </div>
        </div>
      ) : (
        <>
        <!-- Analysis Content -->
        <div class="space-y-6">
          {summary.split('\n\n').map((section) => {
            const lines = section.split('\n');
            const title = lines[0] || '';
            const content = lines.slice(1).join('\n');

            if (title.toLowerCase().includes('urgency level')) {
              const urgencyMatch = content.match(/(Red|Orange|Green)/i);
              const urgencyColor = urgencyMatch ?
                (urgencyMatch[1].toLowerCase() === 'red' ? 'bg-red-100 text-red-800 border-red-200' :
                 urgencyMatch[1].toLowerCase() === 'orange' ? 'bg-orange-100 text-orange-800 border-orange-200' :
                 'bg-green-100 text-green-800 border-green-200') : 'bg-gray-100 text-gray-800 border-gray-200';

              return (
                <div class={`border-l-4 p-4 rounded-r-md ${urgencyColor}`}>
                  <h3 class="text-lg font-semibold mb-2">{title}</h3>
                  <div class="prose prose-sm max-w-none dark:prose-invert">
                    {content}
                  </div>
                </div>
              );
            } else {
              return (
                <div class="bg-white dark:bg-gray-800 overflow-hidden shadow rounded-lg">
                  <div class="px-4 py-5 sm:p-6">
                    <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">
                      {title}
                    </h3>
                    <div class="prose prose-sm max-w-none text-gray-700 dark:text-gray-300 dark:prose-invert">
                      {content}
                    </div>
                  </div>
                </div>
              );
            }
          })}
        </div>

        <!-- Service Gap Solutions -->
        <div class="bg-white dark:bg-gray-800 overflow-hidden shadow rounded-lg">
          <div class="px-4 py-5 sm:p-6">
            <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-6">
              Recommended Solutions
            </h3>

            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
              <!-- Most Impactful Solution - Highlighted -->
              <div class="relative">
                <div class="absolute -top-3 left-1/2 transform -translate-x-1/2">
                  <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800 border-2 border-yellow-300">
                    <svg class="w-3 h-3 mr-1" fill="currentColor" viewBox="0 0 20 20">
                      <path fill-rule="evenodd" d="M11.3 1.046A1 1 0 0112 2v5h4a1 1 0 01.82 1.573l-7 10A1 1 0 018 18v-5H4a1 1 0 01-.82-1.573l7-10a1 1 0 011.12-.38z" clip-rule="evenodd" />
                    </svg>
                    Most Impactful
                  </span>
                </div>
                <div class="border-2 border-yellow-300 bg-gradient-to-br from-yellow-50 to-orange-50 dark:from-yellow-900/20 dark:to-orange-900/20 rounded-lg p-6 shadow-lg">
                  <div class="flex items-center mb-4">
                    <div class="flex-shrink-0">
                      <div class="w-10 h-10 bg-yellow-500 rounded-full flex items-center justify-center">
                        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" />
                        </svg>
                      </div>
                    </div>
                    <div class="ml-4">
                      <h4 class="text-lg font-semibold text-gray-900 dark:text-white">
                        Digital Accessibility Audit
                      </h4>
                      <p class="text-sm text-gray-600 dark:text-gray-400">
                        Comprehensive assessment & modernization
                      </p>
                    </div>
                  </div>
                  <p class="text-sm text-gray-700 dark:text-gray-300 mb-4">
                    Conduct a full digital accessibility audit of municipal websites and online services, followed by targeted improvements to ensure compliance with WCAG guidelines.
                  </p>
                  <div class="flex items-center justify-between">
                    <span class="text-xs font-medium text-yellow-700 dark:text-yellow-300 bg-yellow-100 dark:bg-yellow-900/50 px-2 py-1 rounded">
                      High Priority
                    </span>
                    <span class="text-sm font-semibold text-yellow-800 dark:text-yellow-200">
                      ~$25K - $50K
                    </span>
                  </div>
                </div>
              </div>

              <!-- Solution 2 -->
              <div class="bg-white dark:bg-gray-700 border border-gray-200 dark:border-gray-600 rounded-lg p-6 shadow">
                <div class="flex items-center mb-4">
                  <div class="flex-shrink-0">
                    <div class="w-10 h-10 bg-blue-500 rounded-full flex items-center justify-center">
                      <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7v8a2 2 0 002 2h6M8 7V5a2 2 0 012-2h4.586a1 1 0 01.707.293l4.414 4.414a1 1 0 01.293.707V7M8 7H6a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2v-2" />
                      </svg>
                    </div>
                  </div>
                  <div class="ml-4">
                    <h4 class="text-lg font-semibold text-gray-900 dark:text-white">
                      Community Outreach Program
                    </h4>
                    <p class="text-sm text-gray-600 dark:text-gray-400">
                      Targeted community engagement
                    </p>
                  </div>
                </div>
                <p class="text-sm text-gray-700 dark:text-gray-300 mb-4">
                  Develop targeted outreach programs to connect residents with existing services and resources they may not be aware of.
                </p>
                <div class="flex items-center justify-between">
                  <span class="text-xs font-medium text-blue-700 dark:text-blue-300 bg-blue-100 dark:bg-blue-900/50 px-2 py-1 rounded">
                    Medium Priority
                  </span>
                  <span class="text-sm font-semibold text-gray-900 dark:text-gray-100">
                    ~$15K - $30K
                  </span>
                </div>
              </div>

              <!-- Solution 3 -->
              <div class="bg-white dark:bg-gray-700 border border-gray-200 dark:border-gray-600 rounded-lg p-6 shadow">
                <div class="flex items-center mb-4">
                  <div class="flex-shrink-0">
                    <div class="w-10 h-10 bg-green-500 rounded-full flex items-center justify-center">
                      <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" />
                      </svg>
                    </div>
                  </div>
                  <div class="ml-4">
                    <h4 class="text-lg font-semibold text-gray-900 dark:text-white">
                      Partnership Development
                    </h4>
                    <p class="text-sm text-gray-600 dark:text-gray-400">
                      Collaborate with external organizations
                    </p>
                  </div>
                </div>
                <p class="text-sm text-gray-700 dark:text-gray-300 mb-4">
                  Establish partnerships with community organizations, NGOs, and private sector companies to expand service offerings.
                </p>
                <div class="flex items-center justify-between">
                  <span class="text-xs font-medium text-green-700 dark:text-green-300 bg-green-100 dark:bg-green-900/50 px-2 py-1 rounded">
                    Medium Priority
                  </span>
                  <span class="text-sm font-semibold text-gray-900 dark:text-gray-100">
                    ~$10K - $20K
                  </span>
                </div>
              </div>
            </div>

            <div class="mt-6 p-4 bg-gray-50 dark:bg-gray-700 rounded-lg">
              <p class="text-sm text-gray-600 dark:text-gray-400">
                <strong>Note:</strong> These recommendations are tailored based on the municipality's specific accessibility gaps and your company's geographic focus and industry. Contact our support team for detailed implementation plans and cost estimates.
              </p>
            </div>
          </div>
        </div>

        <!-- Issue-Specific Impact Analysis -->
        <div class="bg-white dark:bg-gray-800 overflow-hidden shadow rounded-lg">
          <div class="px-4 py-5 sm:p-6">
            <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">
              Issue-Specific Impact Analysis: {issueData.top_services_affected[0] || 'Accessibility Barriers'}
            </h3>

            <!-- Issue Summary -->
            <div class="mb-6 p-4 bg-gray-50 dark:bg-gray-700 rounded-lg">
              <div class="flex items-center justify-between mb-3">
                <span class="text-sm font-medium text-gray-700 dark:text-gray-300">Severity Level:</span>
                <span class={`px-2 py-1 text-xs font-medium rounded-full ${
                  issueData.severity === 'critical' ? 'bg-red-100 text-red-800' :
                  issueData.severity === 'moderate' ? 'bg-orange-100 text-orange-800' :
                  'bg-green-100 text-green-800'
                }`}>
                  {issueData.severity.charAt(0).toUpperCase() + issueData.severity.slice(1)}
                </span>
              </div>
              <div class="grid grid-cols-2 gap-4 text-sm">
                <div>
                  <span class="font-medium text-gray-700 dark:text-gray-300">Issues Identified:</span>
                  <span class="ml-2 text-gray-900 dark:text-gray-100">{issueData.issues_count}</span>
                </div>
                <div>
                  <span class="font-medium text-gray-700 dark:text-gray-300">Affected Population:</span>
                  <span class="ml-2 text-gray-900 dark:text-gray-100">{issueData.affected_populations.toLocaleString()}</span>
                </div>
              </div>
              <div class="mt-3">
                <span class="font-medium text-gray-700 dark:text-gray-300">Key Barriers:</span>
                <div class="flex flex-wrap gap-2 mt-1">
                  {issueData.accessibility_barriers.map((barrier) => (
                    <span class="px-2 py-1 text-xs bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200 rounded">
                      {barrier}
                    </span>
                  ))}
                </div>
              </div>
            </div>

            <!-- Impact Chart Container -->
            <div id="impact-chart-container" class="mb-6">
              <!-- Chart will be rendered here by JavaScript -->
            </div>
          </div>
        </div>
        </>
      )}

      <!-- Client-side script to render the impact chart -->
      <script define:vars={{ issueData }}>
        import ImpactChart from '../../components/charts/ImpactChart.client.ts';

        document.addEventListener('DOMContentLoaded', () => {
          // Generate impact data based on the issue type
          const primaryBarrier = issueData.accessibility_barriers[0] || 'Digital accessibility';
          const affectedPopulation = issueData.affected_populations;

          // Calculate impact metrics based on barrier type and population
          let chartData = [];

          if (primaryBarrier.toLowerCase().includes('digital')) {
            chartData = [
              {
                label: 'Digital Accessibility Audit',
                value: Math.round(affectedPopulation * 0.85),
                color: '#eab308',
                description: 'Website modernization and WCAG compliance improvements'
              },
              {
                label: 'Online Service Training',
                value: Math.round(affectedPopulation * 0.65),
                color: '#3b82f6',
                description: 'Digital literacy programs for seniors and vulnerable groups'
              },
              {
                label: 'Mobile App Development',
                value: Math.round(affectedPopulation * 0.45),
                color: '#10b981',
                description: 'Accessible mobile applications for service delivery'
              }
            ];
          } else if (primaryBarrier.toLowerCase().includes('physical')) {
            chartData = [
              {
                label: 'Building Accessibility Retrofits',
                value: Math.round(affectedPopulation * 0.75),
                color: '#ef4444',
                description: 'Ramps, elevators, and entrance modifications'
              },
              {
                label: 'Public Transit Improvements',
                value: Math.round(affectedPopulation * 0.60),
                color: '#f97316',
                description: 'Accessible transportation infrastructure'
              },
              {
                label: 'Community Center Upgrades',
                value: Math.round(affectedPopulation * 0.40),
                color: '#8b5cf6',
                description: 'Facility modifications for accessibility'
              }
            ];
          } else if (primaryBarrier.toLowerCase().includes('transportation')) {
            chartData = [
              {
                label: 'Accessible Public Transit',
                value: Math.round(affectedPopulation * 0.80),
                color: '#06b6d4',
                description: 'Wheelchair-accessible buses and stations'
              },
              {
                label: 'Ride-Sharing Programs',
                value: Math.round(affectedPopulation * 0.55),
                color: '#84cc16',
                description: 'Subsidized accessible transportation services'
              },
              {
                label: 'Community Mobility Centers',
                value: Math.round(affectedPopulation * 0.35),
                color: '#ec4899',
                description: 'Centralized accessible transportation hubs'
              }
            ];
          } else {
            // Default mixed barriers
            chartData = [
              {
                label: 'Multimodal Accessibility Program',
                value: Math.round(affectedPopulation * 0.70),
                color: '#eab308',
                description: 'Comprehensive accessibility improvements across all barriers'
              },
              {
                label: 'Community Support Networks',
                value: Math.round(affectedPopulation * 0.50),
                color: '#3b82f6',
                description: 'Peer support and resource navigation assistance'
              },
              {
                label: 'Digital Inclusion Initiatives',
                value: Math.round(affectedPopulation * 0.40),
                color: '#10b981',
                description: 'Technology access and training programs'
              }
            ];
          }

          // Initialize the impact chart
          const chart = new ImpactChart('impact-chart-container', {
            data: chartData,
            title: `Impact Potential for ${primaryBarrier}`,
            subtitle: `Estimated Canadian citizens who could benefit from targeted solutions`
          });
        });
      </script>

      <!-- Action Buttons -->
      <div class="mt-8 flex space-x-4">
        <button
          class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500"
          onclick="window.print()"
        >
          <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z" />
          </svg>
          Export Report
        </button>

        <a
          href={`/contact?municipality=${encodeURIComponent(municipality || '')}&company=${encodeURIComponent(company?.companyId || '')}`}
          class="inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 dark:bg-gray-800 dark:border-gray-600 dark:text-gray-300 dark:hover:bg-gray-700"
        >
          <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
          </svg>
          Contact Support
        </a>
      </div>
    </div>
  </div>
</LayoutSidebar>

<style>
  .prose p {
    margin-bottom: 1em;
  }

  .prose strong {
    font-weight: 600;
  }

  .prose ul {
    list-style-type: disc;
    padding-left: 1.5em;
    margin: 1em 0;
  }

  .prose li {
    margin: 0.5em 0;
  }
</style>
