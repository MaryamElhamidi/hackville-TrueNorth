---
import LayoutSidebar from '../app/LayoutSidebar.astro';
import { loadMunicipalitySummaries } from '../lib/dashboard/filtering.js';
import { loadCompanies } from '../lib/company/index.js';
import { transformMunicipalityToHeatmapData } from '../lib/dashboard/heatmap.js';

// Load all municipality summaries for the heatmap (not company-filtered)
const municipalities = loadMunicipalitySummaries();
const allCompanies = loadCompanies();

// Transform all municipalities to heatmap data
const heatmapData = transformMunicipalityToHeatmapData(municipalities, undefined);
---

<link href='https://api.mapbox.com/mapbox-gl-js/v3.18.0/mapbox-gl.css' rel='stylesheet' />

<LayoutSidebar title="Service Gap Heatmap">
	<div class="px-4 pt-6 bg-gray-50 dark:bg-gray-900 min-h-screen">
		<div class="max-w-7xl mx-auto">
			<!-- Header -->
			<div class="mb-6">
				<div class="flex items-center justify-between">
					<div>
						<h1 class="text-3xl font-bold text-gray-900 dark:text-white">
							Service Gap Heatmap
						</h1>
						<p class="text-lg text-gray-600 dark:text-gray-400 mt-2">
							Interactive map showing accessibility service gaps across Canada
						</p>
					</div>
					<a
						href="/dashboard"
						class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500"
					>
						‚Üê Back to Dashboard
					</a>
				</div>
			</div>

			<!-- Company Selector -->
			{allCompanies.length > 1 && (
				<div class="mb-6">
					<div class="flex items-center space-x-4">
						<label class="text-sm font-medium text-gray-700 dark:text-gray-300">
							Company Focus:
						</label>
						<select
							id="company-selector-heatmap"
							class="block w-64 pl-3 pr-10 py-2 text-sm border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white"
						>
							{allCompanies.map((comp) => (
								<option value={comp.companyId}>{comp.companyName}</option>
							))}
						</select>
					</div>
				</div>
			)}

			<!-- Heatmap Card -->
			<div class="heatmap-card bg-white dark:bg-gray-800 rounded-xl shadow-xl border border-gray-200 dark:border-gray-700 overflow-hidden animate-fade-in-up">
				<!-- Card Header -->
				<div class="px-6 py-4 bg-gradient-to-r from-blue-600 to-purple-600 text-white">
					<div class="flex items-center justify-between">
						<div>
							<h2 class="text-xl font-bold">Service Gap Analysis</h2>
							<p class="text-blue-100 text-sm">Interactive accessibility heatmap</p>
						</div>
						<div class="flex items-center space-x-2">
							<div class="w-3 h-3 bg-green-400 rounded-full animate-pulse"></div>
							<span class="text-sm font-medium">Live Data</span>
						</div>
					</div>
				</div>

				<!-- Heatmap Container - ServiceGapHeatmap component will create its own UI -->
				<div id="service-gap-heatmap-container" class="w-full h-[620px] relative">
					<!-- Component will replace this content -->
				</div>
			</div>
		</div>
	</div>
</LayoutSidebar>

<script define:vars={{ heatmapData, allCompanies }}>
	// Make heatmap data and companies available to client-side scripts
	window.heatmapData = heatmapData;
	window.allCompanies = allCompanies;
</script>

<script>
	import '../modules/DashBoard-heatmap.client.ts';

	// Handle company selector change for heatmap
	document.addEventListener('DOMContentLoaded', () => {
		const companySelector = document.getElementById('company-selector-heatmap');
		if (companySelector) {
			companySelector.addEventListener('change', () => {
				// For demo purposes, we'll reload the page. In a real app,
				// this would update the active company in the session/user context
				window.location.reload();
			});
		}
	});
</script>

<style>
	/* Custom animations */
	@keyframes fade-in-up {
		from {
			opacity: 0;
			transform: translateY(30px);
		}
		to {
			opacity: 1;
			transform: translateY(0);
		}
	}

	.animate-fade-in-up {
		animation: fade-in-up 0.8s ease-out;
	}

	/* Enhanced marker animations */
	@keyframes marker-pulse {
		0%, 100% {
			transform: scale(1);
			opacity: 1;
		}
		50% {
			transform: scale(1.1);
			opacity: 0.8;
		}
	}

	.municipality-marker {
		transition: all 0.3s ease;
	}

	.municipality-marker:hover {
		animation: marker-pulse 1s infinite;
		filter: drop-shadow(0 0 8px rgba(59, 130, 246, 0.6));
	}

	/* Smooth transitions for filters */
	.filter-checkbox {
		transition: all 0.2s ease;
	}

	.filter-checkbox:hover {
		transform: scale(1.05);
	}

	/* Card hover effects */
	.heatmap-card {
		transition: all 0.3s ease;
	}

	.heatmap-card:hover {
		transform: translateY(-2px);
		box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
	}

	/* Loading animation */
	@keyframes shimmer {
		0% {
			background-position: -200px 0;
		}
		100% {
			background-position: calc(200px + 100%) 0;
		}
	}

	.animate-shimmer {
		background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
		background-size: 200px 100%;
		animation: shimmer 1.5s infinite;
	}

	/* Mapbox popup styling */
	.municipality-popup .mapboxgl-popup-content {
		background: white;
		border-radius: 8px;
		box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
		border: 1px solid #e5e7eb;
		padding: 0;
		font-family: inherit;
	}

	.municipality-popup .mapboxgl-popup-tip {
		border-width: 8px;
		border-color: white;
	}

	.municipality-popup .mapboxgl-popup-close-button {
		color: #6b7280;
		font-size: 18px;
		padding: 4px 8px;
	}

	.municipality-popup .mapboxgl-popup-close-button:hover {
		color: #374151;
		background: #f3f4f6;
		border-radius: 4px;
	}
</style>
